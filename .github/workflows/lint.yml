name: Lint

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for WIP/fixup commits
        if: github.event_name == 'pull_request'
        run: |
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}
          PATTERN='^[a-f0-9]+ (wip[: ]|fixup!|squash!|amend!|\[skip ci\])'
          WIP_COMMITS=$(git log --oneline "$BASE_SHA..$HEAD_SHA" | \
            grep -iE "$PATTERN" || true)
          if [ -n "$WIP_COMMITS" ]; then
            echo "Error: Found WIP/fixup commits that should be cleaned up:"
            echo "$WIP_COMMITS"
            echo ""
            echo "Please squash or rebase these commits before merging."
            exit 1
          fi

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Install dev dependencies
        run: uv sync

      - name: Read Qt version
        id: qt-version
        run: echo "version=$(cat .qt-version)" >> $GITHUB_OUTPUT

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ steps.qt-version.outputs.version }}

      - name: Format C++
        run: find . -name '*.cpp' -o -name '*.h' | xargs uv run clang-format -i

      - name: Format QML
        run: find . -name '*.qml' | xargs qmlformat -i

      - name: Check formatting
        run: git diff --exit-code

      - name: Trailing whitespace
        run: |
          INCLUDES="--include=*.cpp --include=*.h --include=*.qml"
          INCLUDES="$INCLUDES --include=*.yml --include=*.yaml"
          INCLUDES="$INCLUDES --include=*.md --include=*.txt --include=*.ts"
          if grep -rn '[[:blank:]]$' $INCLUDES --exclude-dir=.venv .; then
            echo "Error: Found trailing whitespace"
            exit 1
          fi

      - name: End of file fixer
        run: |
          files_without_newline=""
          find_args="-type f \( -name *.cpp -o -name *.h -o -name *.qml"
          find_args="$find_args -o -name *.yml -o -name *.yaml"
          find_args="$find_args -o -name *.md -o -name *.txt -o -name *.ts \)"
          find_args="$find_args -not -path ./.git/* -not -path ./.venv/*"
          for file in $(eval "find . $find_args"); do
            if [ -s "$file" ] && [ "$(tail -c 1 "$file" | wc -l)" -eq 0 ]; then
              files_without_newline="$files_without_newline $file"
            fi
          done
          if [ -n "$files_without_newline" ]; then
            echo "Error: Files missing final newline:$files_without_newline"
            exit 1
          fi

      - name: Check YAML
        run: uv run yamllint .

      - name: Check large files
        run: |
          large_files=$(find . -type f -size +500k \
            -not -path './.git/*' -not -path './.venv/*')
          if [ -n "$large_files" ]; then
            echo "Error: Found large files (>500KB):"
            echo "$large_files"
            exit 1
          fi

      - name: Check merge conflict markers
        run: |
          INCLUDES="--include=*.cpp --include=*.h --include=*.qml"
          INCLUDES="$INCLUDES --include=*.yml --include=*.yaml --include=*.md"
          EXCLUDES="--exclude=lint.yml --exclude-dir=.venv"
          if grep -rn '<<<<<<< \|=======$\|>>>>>>> ' $INCLUDES $EXCLUDES .; then
            echo "Error: Found merge conflict markers"
            exit 1
          fi

      - name: Check line endings (LF only)
        run: |
          INCLUDES="--include=*.cpp --include=*.h --include=*.qml"
          INCLUDES="$INCLUDES --include=*.yml --include=*.yaml"
          INCLUDES="$INCLUDES --include=*.md --include=*.txt --include=*.ts"
          if grep -rIl $'\r' $INCLUDES --exclude-dir=.venv .; then
            echo "Error: Found CRLF line endings (should be LF)"
            exit 1
          fi

      - name: Check translations complete
        run: ./scripts/check-translations.sh
